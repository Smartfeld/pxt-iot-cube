<xml xmlns="https://developers.google.com/blockly/xml"><block type="pxt-on-start" x="10" y="10"><statement name="HANDLER"><block type="typescript_statement" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="namespace LoRa {" line1="    let rxStack = [&quot;&quot;]" line2="    let eventStack = [&quot;&quot;]" line3="    export let message = &quot;&quot;" line4="" line5="    let status = 0" line6="    let FLAG_MSG_REQ = 0" line7="" line8="    serial.redirect(SerialPin.P8, SerialPin.P13, BaudRate.BaudRate115200)" line9="    " line10="" line11="    /**" line12="     * Communication" line13="     */" line14="" line15="    function writeSerial(command: string) {" line16="        serial.writeString(command + &quot;\r\n&quot;)" line17="    }" line18="" line19="    function readSerial(command: string) {" line20="        return serial.readString()" line21="    }" line22="" line23="    //% blockId=GetLatestMessage" line24="    //% block=&quot;Get serial message&quot;" line25="    //% advanced=true" line26="    export function getSerialMessage() {" line27="        return message" line28="    }" line29="" line30="    //% blockId=SerialListener" line31="    //% block=&quot;Serial Listener&quot;" line32="    //% advanced=true" line33="    export function serialListener(){" line34="        let rc = -1" line35="        if (FLAG_MSG_REQ == 0) {" line36="            let res = serial.readUntil(&quot;\r\n&quot;)" line37="            if (res.length &gt; 0) {" line38="                res = res.replace(&quot;\r\n&quot;, &quot;&quot;)" line39="                for(let i=0; i&lt;strRAK_RC.length; i++){" line40="                    if(res.includes(strRAK_RC[i])){" line41="                        rc = i" line42="                    }" line43="                }" line44="                if( rc == -1){" line45="                    if (res.includes(&quot;EVT&quot;)) {" line46="                        eventStack.push(res)" line47="                    }" line48="                    else {" line49="                        rxStack.push(res)" line50="                        message = res" line51="                    }" line52="                }" line53="            }" line54="        }" line55="    }" line56="" line57="    //% blockId=getRxStack" line58="    //% block=&quot;Get RX-Stack Item&quot;" line59="    //% advanced=true" line60="    export function getRxStack(){" line61="        return rxStack.pop()" line62="    }" line63="" line64="    //% blockId=writeATCommand" line65="    //% block=&quot;AT | Command %typ Paramter %value&quot;" line66="    //% advanced=true" line67="    export function writeATCommand(typ: string, value: string){" line68="        let command = &quot;AT+&quot; + typ + &quot;=&quot; + value" line69="        writeSerial(command)" line70="    }" line71="" line72="    //% blockId=getParameter" line73="    //% block=&quot;Get | Parameter %typ&quot;" line74="    //% advanced=false" line75="    export function getParameter(typ: eRUI3_PARAM) {" line76="        let command2 = &quot;AT+&quot; + strRAK_PARAM[typ] + &quot;=?&quot;       " line77="        writeSerial(command2)" line78="        basic.pause(100)" line79="        return message.replace(&quot;AT+&quot; + strRAK_PARAM[typ] + &quot;=&quot;, &quot;&quot;)" line80="    }" line81="" line82="    //% blockId=setParameter" line83="    //% block=&quot;Set | Parameter %typ to %value&quot;" line84="    //% advanced=false" line85="    export function setParameter(typ: eRUI3_PARAM, value: string) {" line86="        let command3 = &quot;AT+&quot; + strRAK_PARAM[typ] + &quot;=&quot; + value" line87="        writeSerial(command3)" line88="    }" line89="" line90="    /**" line91="     * Device Control" line92="     */" line93="    //% blockId=DeviceStatus" line94="    //% block=&quot;Get Device Status Bit %mask&quot;" line95="    //% advanced=false" line96="    export function getStatus(mask: eSTATUS_MASK){" line97="        return (status &amp; mask)" line98="    }" line99="" line100="    //% blockId=DeviceReset" line101="    //% block=&quot;Reset LoRa Module&quot;" line102="    //% advanced=true" line103="    export function resetModule() {" line104="        writeSerial(&quot;ATZ&quot;)" line105="    }" line106="" line107="    //% blockId=DeviceSleep" line108="    //% block=&quot;LoRa Module sleep for %time ms&quot;" line109="    //% advanced=true" line110="    export function sleep(time: number) {" line111="        writeATCommand(&quot;SLEEP&quot;, time.toString())" line112="    }" line113="" line114="" line115="    /**" line116="     * Procedures" line117="     */" line118="" line119="    //% blockId=&quot;OTAASetup&quot;" line120="    //% block=&quot;OTAA Setup: AppEUI %AppEUI | DevEUI %DevEUI | AppKey %AppKey&quot;" line121="    export function OTAA_Setup(AppEUI: string, DevEUI: string, AppKey: string) {" line122="        setParameter(eRUI3_PARAM.NWM, &quot;1&quot;)              //Set work mode LoRaWAN" line123="        setParameter(eRUI3_PARAM.NJM, &quot;1&quot;)              //Set activation to OTAA" line124="        setParameter(eRUI3_PARAM.CLASS, &quot;A&quot;)            //Set class A" line125="        setParameter(eRUI3_PARAM.BAND, eBands.EU868.toString())     //Set band EU868" line126="        setParameter(eRUI3_PARAM.DEVEUI, DevEUI)" line127="        setParameter(eRUI3_PARAM.APPEUI, AppEUI)" line128="        setParameter(eRUI3_PARAM.APPKEY, AppKey)" line129="        basic.pause(300)" line130="        resetModule()" line131="    }" line132="    " line133="    //% blockId=&quot;Network_Join&quot;" line134="    //% block=&quot;LoRa Network Join | Join: %join | On Power-up: %auto_join&quot;" line135="    export function LoRa_Join(join: eBool, auto_join: eBool) {" line136="        writeATCommand(&quot;JOIN&quot;, join + &quot;:&quot; + auto_join + &quot;:10:8&quot;)" line137="    }" line138="" line139="    //% blockId=&quot;LoRa_Send&quot;" line140="    //% block=&quot;LoRa Send | data %data on channel %chanNum&quot;" line141="    export function LoRa_Send(data: string, chanNum: Channels,) {" line142="        writeATCommand(&quot;SEND&quot;, chanNum + &quot;:&quot; + data)" line143="    }" line144="}" numlines="145"></mutation></block></statement></block></xml>